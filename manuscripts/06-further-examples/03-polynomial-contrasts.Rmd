name: polynomial-contrast-weights

## Polynomial contrasts

::: columns

:::: pull-left

- （順序が決まっている）隣り合う水準同士を比較
  - 水準間で同じペースで増加・減少？
  - 水準間毎に，増加・減少のペースが変わる？

--

- 例：語の頻度の効果を，隣り合う水準と比べる
    1. 低頻度
    2. 中頻度・低
    3. 中頻度・高
    4. 高頻度

--

  - 主な対比は次の3つ
      1. 1次関数ペース（Linear; どの水準間でも一定ペースで増加・減少？）
      2. 2次関数ペース（Quadratic; 次の水準間に移るほど増加・減少が激しい・穏やか？）
      3. 3次関数ペース（Cubic; 次の水準間に移るほど増加・減少が激しい・穏やか？）

::::

:::: pull-right

```{r}
#| schema-simdat3,
#| echo = FALSE

label.y <- summary_simdat3 |>
  filter(
    F != "low"
  ) |>
  mutate(
    M = M - abs(lag.M)/2,
    label = c(
      "paste(italic(β)[1], '= Linear trend')",
      "paste(italic(β)[2], '= Quadratic trend')",
      "paste(italic(β)[3], '= Cubic trend')"
    )
  )

summary_simdat3 |>
  (
    \(d){
      qplot(
        x = F, y = M,
        group = 1,
        data = d,
        geom = c("point", "line")
      ) +
      geom_errorbar(
        aes(
          max = M + SE,
          min = M - SE
        ),
        width = 0
      ) +
      labs(
        y = "Mean DV",
        x = "Factor F"
      ) +
      geom_hline(
        yintercept = d$GM,
        linetype = "dashed"
      )
    }
  )() +
  geom_label(
    aes(
      x = "low",
      y = mean(M),
    ),
    parse = TRUE,
    label = "paste(italic(β)[0], '= Grand Mean')"
  ) +
  #### Cubic trend
  stat_smooth(
    #inherit.aes = FALSE,
    aes(
      x = as.numeric(F),
      y = M
    ),
    method = "lm",
    formula = y ~ poly(x, 3),
    size = 1,
    colour = "red",
    se = FALSE
  ) +
  #### quadratic trend
  stat_smooth(
    #inherit.aes = FALSE,
    aes(
      x = as.numeric(F),
      y = M
    ),
    method = "lm",
    formula = y ~ poly(x, 2),
    size = 1,
    colour = "red",
    linetype = "dashed",
    se = FALSE
  ) +
  #### linear trend
  stat_smooth(
    inherit.aes = FALSE,
    aes(
      x = as.numeric(F),
      y = M
    ),
    method = "lm",
    formula = y ~ x,
    size = 1,
    colour = "red",
    linetype = "88",
    se = FALSE
  ) +
  #### labels
  geom_label(
    data = label.y,
    aes(
      x = F,
      y = M,
      label = label
    ),
    parse = TRUE
  ) +
  labs(
    x = "Word Frequency",
    y = "Reaction Time"
  )
```

::::

:::

---

## Polynomial contrasts

::: columns

:::: pull-left

::::: block

### 検証する帰無仮説

1. 中頻度・低のRT $\mu_2$ は，低頻度語へのRT $\mu_1$ と同じか？
2. 中頻度・高のRT $\mu_3$ は，中頻度・低のRT $\mu_2$ と同じか？
3. 高頻度のRT $\mu_4$ は， 中頻度・高のRT $\mu_3$ と同じか？

<!--
4. 全体平均 $\frac{\mu_1 + \mu_2 + \mu_3 + \mu_4}{4}$ は0秒と同じ？
-->

:::::

::::

:::: pull-right

```{r}
#| ref.label = c('schema-simdat3'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::

---

## Polynomial contrasts

::: columns

:::: pull-left

::::: block

### 検証する帰無仮説

言葉を数式に変換

$$\begin{aligned}
{H_0}_{2-1}: & \mu_2 = \mu_1 \\
{H_0}_{3-2}: & \mu_3 = \mu_2 \\
{H_0}_{4-3}: & \mu_4 = \mu_3
\end{aligned}$$

:::::

::::

:::: pull-right

```{r}
#| ref.label = c('schema-simdat3'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::

---

## Polynomial contrasts

::: columns

:::: pull-left

::::: block

### 検証する帰無仮説

両辺から右辺部分を引く

$$\begin{aligned}
{H_0}_{2-1}: & \mu_2 - \mu_1 = 0 \\
{H_0}_{3-2}: & \mu_3 - \mu_2 = 0 \\
{H_0}_{4-3}: & \mu_4 - \mu_3 = 0
\end{aligned}$$

:::::

::::

:::: pull-right

```{r}
#| ref.label = c('schema-simdat3'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::

---

## Polynomial contrasts

::: columns

:::: pull-left

::::: block

### 検証する帰無仮説

- $\mu_1, ..., \mu_4$ の内，各式に存在しないものを書き加える
- 書き加えるときには，追加するものに0を掛けてから

$$\begin{aligned}
{H_0}_{2-1}: & \mu_2 - \mu_1 + 0 \times \mu_3 + 0 \times \mu_4 = 0 \\
{H_0}_{3-2}: & \mu_3 - \mu_2 + 0 \times \mu_1 + 0 \times \mu_4 = 0 \\
{H_0}_{4-3}: & \mu_4 - \mu_3 + 0 \times \mu_1 + 0 \times \mu_2 = 0
\end{aligned}$$

:::::

::::

:::: pull-right

```{r}
#| ref.label = c('schema-simdat3'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::

---

## Polynomial contrasts

::: columns

:::: pull-left

::::: block

### 検証する帰無仮説

- $\mu_1, ..., \mu_4$ の順番を整理
- $\mu_1, ..., \mu_4$に掛かっている数が，それぞれに対する重みづけ

$$\begin{aligned}
{H_0}_{2-1}: & (-1) \times \mu_1 + 1\times \mu_2 + 0 \times \mu_3 + 0 \times \mu_4 = 0 \\
{H_0}_{3-2}: & 0 \times \mu_1 + (-1) \times \mu_2 + 1 \times \mu_3 + 0 \times \mu_4 = 0 \\
{H_0}_{4-3}: & 0 \times \mu_1 + 0 \times \mu_2 + (-1) \times \mu_3 + 1 \times \mu_4= 0
\end{aligned}$$

:::::

::::

:::: pull-right

```{r}
#| ref.label = c('schema-simdat3'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::

---

## 重みづけを抽出し，「仮説行列」に書く

$\mu_1$, $\mu_2$, $\mu_3$, $\mu_4$ には重みづけがある

::: columns

:::: pull-left

$$\begin{aligned}
{H_0}_{2-1}: & (-1) \times \mu_1 + 1\times \mu_2 + 0 \times \mu_3 + 0 \times \mu_4 = 0 \\
{H_0}_{3-2}: & 0 \times \mu_1 + (-1) \times \mu_2 + 1 \times \mu_3 + 0 \times \mu_4 = 0 \\
{H_0}_{4-3}: & 0 \times \mu_1 + 0 \times \mu_2 + (-1) \times \mu_3 + 1 \times \mu_4= 0
\end{aligned}$$

::::

:::: pull-right

- 各行：**帰無仮説**
  - ${H_0}_{2-1}$: `c2vs1`
  - ${H_0}_{3-2}$: `c3vs2`
  - ${H_0}_{4-3}$: `c4vs3`
- 各列：各水準への**重み**

```{r}
#| polynomial-hypothesis-matrix,
#| echo = TRUE,
#| eval = FALSE

HcRE <- rbind(
  c2vs1 = c(low = -1, `med-low` =  1, `med-hi` =  0, hi = 0),
  c3vs2 = c(low =  0, `med-low` = -1, `med-hi` =  1, hi = 0),
  c4vs3 = c(low =  0, `med-low` =  0, `med-hi` = -1, hi = 1)
)
```

```{r}
#| ref.label = c('polynomial-hypothesis-matrix'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::

---

`r chunk_reveal("polynomial-hypothesis-matrix-transpose", left_assign = "detect", title = "## 重みづけを抽出し，「仮説行列」に書く",  display_type = c("code", "output", "md"), md = c("仮説行列", "仮説行列を転置 *transpose*  \n今度は各行が水準，各列が仮説に変わる"))`


```{r}
#| polynomial-hypothesis-matrix-transpose,
#| include = FALSE
HcRE |>
  t()
```

---

`r chunk_reveal("polynomial-hypothesis-matrix-ginv", left_assign = "detect", title = "## 一般化逆行列を使い，仮説行列を対比行列に変換",  display_type = c("code", "output", "md"), md = c("仮説行列に対し…", "一般化逆行列を適用，仮説行列を対比行列に変換", "仮説行列に対し…", "一般化逆行列を適用，仮説行列を対比行列に変換", "行名・列名を再付与", "分数表記に"))`


```{r}
#| polynomial-hypothesis-matrix-ginv,
#| include = FALSE

XcRE <- HcRE |>
  hypr::ginv2()

XcRE <- HcRE |>
  ginv() |>
  provideDimnames(
    base = dimnames(HcRE)[2:1]
  ) |>
  fractions()
```

---

`r chunk_reveal("polynomial-hypothesis-matrix-ginv-contr-sdif", left_assign = "detect", title = "## 一般化逆行列を使い，仮説行列を対比行列に変換",  display_type = c("code", "output", "md"), md = c("仮説行列に一般化逆行列を適用したもの", "4水準の時のpolynomial contrast", "分数表記に"))`


```{r}
#| polynomial-hypothesis-matrix-ginv-contr-sdif,
#| include = FALSE

XcRE

contr.sdif(4) |>
  fractions()
```

---

`r chunk_reveal("manual-polynomial-contrasts", left_assign = "detect", break_type = "rotate", title = "## 対比行列を要因に当てはめ，線形モデルを実行",  display_type = c("code", "output", "md"), md = c("**contr.sdif(3)**で作ったpolynomial contrastsを適用", "仮説行列から作ったpolynomial contrastsを適用", "希望するcontrastsになったか確認", "統計モデル構築", "結果表示", "より見やすく結果表示"), widths = c(3, 2, 1))`

```{r}
#| manual-polynomial-contrasts,
#| include = FALSE

contrasts(simdat3$F) <- contr.sdif(4) |> fractions() #ROTATE
contrasts(simdat3$F) <- XcRE #ROTATE

contrasts(simdat3$F)

lm(DV ~ F, data = simdat3) |>
  tidy(conf.int = TRUE, conf.level = 0.95) |>
  mutate(
    `95% CI` = paste0(
      "[",
      conf.low |> round(2),
      ", ",
      conf.high |> round(2),
      "]"
    )
  ) |>
  relocate(`95% CI`, .after = estimate) |>
  dplyr::select(-c(std.error, conf.low, conf.high)) |>
  kable(
    digits = 2,
    escape = FALSE,
    col.names = c(
      'Predictor',
      'Estimate',
      '95% CI',
      '$t$-value',
      '$p$-value'
    )
  )
```

---

## 統計モデルから仮説を検証

::: columns

:::: pull-left

::::: block

<!--
### 検証する帰無仮説
-->

1. 中頻度・低のRT $\mu_2$ は，低頻度語へのRT $\mu_1$ と同じか？
    - `Fc2vs1`より， $\mu_2 - \mu_1 = 10$
    - $t$ 値が $t(16)$ の両側2.5% $t \leq `r qt(df = 16, 0.025)`, `r qt(df = 16, 0.975)` \leq t$にないため，中頻度・低へのRTは低頻度語へのRTより有意に長いとは言えない
2. 中頻度・高へのRT $\mu_3$ は，中頻度・低へのRT $\mu_2$ と同じか？
    - `Fc3vs2`より， $\mu_3 - \mu_2 = -10$
    - $t$ 値が $t(16)$ の両側2.5%にないため，中頻度・高へのRTは中頻度・低へのRTより有意に長いとは言えない
3. 高頻度へのRT $\mu_4$ は， 中頻度・高のRT $\mu_3$ と同じか？
    - `Fc4vs3`より， $\mu_4 - \mu_3 = 30$
    - $t$ 値が $t(16)$ の両側2.5%にあるため，高頻度へのRTは中頻度・高へのRTより有意に長い

:::::

::::

:::: pull-right

```{r}
#| ref.label = c('manual-polynomial-contrasts'),
#| echo = FALSE,
#| eval = TRUE
```

```{r}
#| ref.label = c('fig-simdat3'),
#| echo = FALSE,
#| eval = TRUE
```

::::

:::